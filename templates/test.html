<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Test</title>
    <link rel="stylesheet" href="/static/styles2.css">
</head>

<body>
    <div class="app-container">
        <!-- ‚úÖ Sidebar -->
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="#" onclick="showPage('dashboard')">Dashboard</a></li>
                    <li><a href="#" onclick="showPage('home')">Home</a></li>
                    <li><a href="#" onclick="showPage('settings')">Settings</a></li>
                    <li><a href="#" onclick="showPage('user')">User</a></li>
                </ul>
            </nav>
        </aside>

        <!-- ‚úÖ Main Content Wrapper -->
        <div class="main-content">
            <div class="test-container">
                <h1>English Speech Test</h1>
                <h3>Current Level: <span id="current-level">Basic/Beginner</span></h3>
                <p id="test-sentence">Click "Generate Sentence" to begin!</p>
                <button id="generate-btn" onclick="generateSentence()">Generate Sentence</button>
                <button id="start-speech-btn" onclick="startSpeechRecognition()" disabled>üéôÔ∏è Speak</button>
                <button id="stop-speech-btn" onclick="stopSpeechRecognition()" disabled>üõë Stop</button>

                <h2>Speech Test Result</h2>
                <p id="test-result">Your accuracy will be displayed here...</p>
                <h3>Points: <span id="points">0</span>/5</h3>
            </div>
        </div>
    </div>
</body>
</html>
 <script>
    let sentences = { basic: [], intermediateLow: [], intermediateHigh: [], advanced: [], native: [] };
    let levels = ["Basic/Beginner", "Intermediate Low", "Intermediate High", "Advanced", "Native/Fluent"];
    let currentLevelIndex = 0;
    let testCount = 0;
    const totalTests = 5;
    let totalScore = 0;
    let points = 0;
    let recognition;

    // ‚úÖ Start Speech Recognition
    function startSpeechRecognition() {
        console.log("üéôÔ∏è Requesting microphone access...");

        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert("‚ùå Speech Recognition is not supported in this browser. Try Chrome or Edge.");
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();

        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = "en-US";

        recognition.onstart = function () {
            console.log("üéôÔ∏è Microphone activated. Start speaking...");
            document.getElementById("test-result").textContent = "Listening...";
            document.getElementById("stop-speech-btn").disabled = false;
        };

        recognition.onspeechend = function () {
            console.log("üõë Speech ended automatically.");
            recognition.stop();
        };

        recognition.onresult = function (event) {
            let userSpeech = event.results[0][0].transcript;
            console.log("‚úÖ Recognized Speech:", userSpeech);

            let targetSentence = document.getElementById("test-sentence").textContent;
            analyzeSpeech(targetSentence, userSpeech);
        };

        recognition.onerror = function (event) {
            console.error("‚ùå Speech recognition error:", event.error);
            alert(`Error with speech recognition: ${event.error}`);
        };

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(() => {
                console.log("‚úÖ Microphone permission granted!");
                recognition.start();
            })
            .catch(error => {
                console.error("‚ùå Microphone access denied:", error);
                alert("Microphone access is blocked. Enable it in your browser settings.");
            });
    }

    // ‚úÖ Stop Speech Recognition
    function stopSpeechRecognition() {
        if (recognition) {
            console.log("üõë Stopping speech recognition...");
            recognition.stop();
            document.getElementById("test-result").textContent = "Speech recognition stopped.";
            document.getElementById("stop-speech-btn").disabled = true;
        } else {
            console.warn("‚ö†Ô∏è No active speech recognition session.");
        }
    }

    // ‚úÖ Fetch Sentences from Flask API on Page Load
    async function loadSentences() {
        try {
            console.log("üîÑ Fetching sentences from server...");
            const response = await fetch('/get-test-sentences');

            if (!response.ok) {
                console.error(`‚ùå Fetch failed: ${response.status} ${response.statusText}`);
                throw new Error(`Failed to fetch sentences: ${response.status}`);
            }

            const data = await response.json();
            console.log("‚úÖ Received JSON:", data);

            if (!data.basic || !data.intermediateLow || !data.intermediateHigh || !data.advanced || !data.native) {
                console.error("‚ùå Invalid JSON structure:", data);
                throw new Error("Invalid JSON structure.");
            }

            sentences = data;
            console.log("‚úÖ Sentences successfully loaded:", sentences);
        } catch (error) {
            console.error("‚ùå Error loading sentences:", error);
            document.getElementById("test-sentence").textContent = "Error loading sentences.";
        }
    }

    let usedSentences = {}; // Track used sentences for each level

async function generateSentence() {
    console.log("üé≤ Generating sentence...");

    if (!sentences.basic.length && !sentences.intermediateLow.length && !sentences.intermediateHigh.length && !sentences.advanced.length && !sentences.native.length) {
        console.warn("‚ö†Ô∏è Sentences are empty, fetching...");
        await loadSentences();
    }

    let levelKey = ["basic", "intermediateLow", "intermediateHigh", "advanced", "native"][currentLevelIndex]; // Force ordered selection
    let levelSentences = sentences[levelKey];

    if (!levelSentences || levelSentences.length === 0) {
        console.error(`‚ùå No sentences found for level: ${levels[currentLevelIndex]}`);
        document.getElementById("test-sentence").textContent = "Error: No sentences available!";
        return;
    }

    // ‚úÖ Initialize usedSentences for the current level if empty
    if (!usedSentences[levelKey] || usedSentences[levelKey].length === 0) {
        usedSentences[levelKey] = [...levelSentences]; // Clone sentences
        usedSentences[levelKey] = usedSentences[levelKey].sort(() => Math.random() - 0.5); // Shuffle
        console.log("üîÄ Shuffled Sentences for:", levelKey, usedSentences[levelKey]);
    }

    // ‚úÖ Pick the first unused sentence and remove it from the list
    let testSentence = usedSentences[levelKey].shift();

    document.getElementById("test-sentence").textContent = testSentence;
    document.getElementById("start-speech-btn").disabled = false;

    console.log(`‚úÖ Generated sentence from ${levelKey}: ${testSentence}`);
}


    // ‚úÖ Analyze Speech & Adjust Points
    async function analyzeSpeech(targetSentence, userSpeech) {
        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target_sentence: targetSentence, user_speech: userSpeech }),
            });

            if (!response.ok) {
                throw new Error(`Failed to analyze pronunciation: ${response.statusText}`);
            }

            const result = await response.json();
            console.log("üéôÔ∏è Analysis result:", result);

            let accuracy = result.accuracy || 0;
            totalScore += accuracy;
            testCount++;

            if (accuracy >= 80) points++; // Award points for good accuracy
            document.getElementById('points').textContent = points; // Update points in UI

            document.getElementById('test-result').innerHTML = `
                <p><strong>Target Sentence:</strong> "${targetSentence}"</p>
                <p><strong>Your Speech:</strong> "${userSpeech}"</p>
                <p><strong>Pronunciation Accuracy:</strong> ${accuracy.toFixed(2)}%</p>
            `;

            if (testCount >= totalTests) adjustLevel();
        } catch (error) {
            console.error("‚ùå Error analyzing pronunciation:", error);
            document.getElementById('test-result').textContent = "Error analyzing speech.";
        }
    }

    function adjustLevel() {
    console.log(`üìä Points: ${points}/5 | Current Level: ${levels[currentLevelIndex]}`);

    if (points >= 3 && currentLevelIndex < levels.length - 1) {
        currentLevelIndex++; // Move to the next level
        document.getElementById("current-level").textContent = levels[currentLevelIndex];
        alert(`üéâ You have leveled up to ${levels[currentLevelIndex]}!`);

        points = 0;
        testCount = 0;
        totalScore = 0;
        usedSentences = {}; // ‚úÖ Reset used sentences to start fresh

        document.getElementById('points').textContent = points;
    } else if (currentLevelIndex === levels.length - 1 && testCount >= totalTests) {
        showFinalScore(); // ‚úÖ Show final score when all levels are completed
    } else {
        alert(`‚ö†Ô∏è You need at least 3/5 to level up. Keep practicing!`);
        testCount = 0;
    }

    document.getElementById('points').textContent = points;
}


function showFinalScore() {
    let performanceComments = [
        { min: 90, message: "üî• Excellent! You're near fluent!" },
        { min: 80, message: "‚úÖ Great job! Almost there!" },
        { min: 70, message: "üëç Good work! Keep improving!" },
        { min: 50, message: "‚ö†Ô∏è Decent, but more practice is needed!" },
        { min: 0, message: "‚ùå Needs improvement. Keep going!" }
    ];

    let finalPercentage = Math.floor((totalScore / (totalTests * levels.length)) * 100);
    let finalComment = performanceComments.find(c => finalPercentage >= c.min).message;

    // ‚úÖ Update final score section instead of using an alert
    document.getElementById("final-score").innerHTML = `üìù <strong>Your Overall Score:</strong> ${finalPercentage}%`;
    document.getElementById("final-comment").innerHTML = `üí¨ <strong>Final Comment:</strong> ${finalComment}`;

    // ‚úÖ Show the final score section
    document.getElementById("final-score-section").style.display = "block";
}


    document.addEventListener("DOMContentLoaded", async function () { await loadSentences(); });

    </script>
</body>
</html>

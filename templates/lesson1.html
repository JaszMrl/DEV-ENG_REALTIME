<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lesson 1: Vowel Sounds</title>
  <link rel="stylesheet" href="/static/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f7f7f7;
    }

    .app-container {
      display: flex;
    }

    .sidebar {
      background-color: #333;
      color: white;
      width: 250px;
      height: 100vh;
      padding: 20px;
      position: fixed;
    }

    .sidebar nav ul {
      list-style: none;
      padding: 0;
    }

    .sidebar nav ul li {
      margin-bottom: 20px;
    }

    .sidebar nav ul li a {
      text-decoration: none;
      color: white;
      font-size: 1rem;
      padding: 10px 15px;
      display: block;
      border-radius: 5px;
      transition: background-color 0.3s, transform 0.2s;
    }

    .sidebar nav ul li a:hover,
    .sidebar nav ul li a.active {
      background-color: #3B82F6;
      transform: translateX(5px);
    }

    .main-content {
      flex-grow: 1;
      margin-left: 250px;
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }

    .lesson-container {
      width: 100%;
      max-width: 800px;
      padding: 0 20px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .section {
      margin-bottom: 30px;
    }

    .word-button {
      display: inline-block;
      margin: 5px;
      padding: 10px 15px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .try-section input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .try-section button {
      margin-right: 10px;
    }

    #listening-indicator {
      display: none;
      font-weight: bold;
      color: #007BFF;
      margin-top: 10px;
      animation: glow 1.2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 5px #007BFF, 0 0 10px #007BFF;
      }
      to {
        text-shadow: 0 0 10px #33aaff, 0 0 20px #33aaff;
      }
    }

    .practice-feedback {
      font-weight: bold;
      margin-top: 5px;
    }

    #next-quiz-btn {
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: static;
        text-align: center;
      }

      .main-content {
        margin-left: 0;
        padding: 20px;
        align-items: center;
      }

      .lesson-container {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <nav>
        <ul>
          <li><a href="{{ url_for('home') }}">
            <img src="/static/icons/dashboard.svg" width="20" style="margin-right: 10px;"> Dashboard</a>
          </li>
          <li><a href="{{ url_for('user') }}">
            <img src="/static/icons/user.svg" width="20" style="margin-right: 10px;"> User</a>
          </li>
          <li><a href="{{ url_for('settings') }}">
            <img src="/static/icons/settings.svg" width="20" style="margin-right: 10px;"> Settings</a>
          </li>
          <li>
            <a href="{{ url_for('speech_test') }}" style="display: flex; align-items: center;">
              <img src="/static/icons/mic.svg" width="24" height="24" style="margin-right: 12px;"> 
              <span>Speech Test</span>
            </a>
          </li>            
          <li>
            <a href="{{ url_for('learn') }}" class="{% if current_page == 'learn' %}active{% endif %}">
              <img src="/static/icons/book.svg" width="20" style="margin-right: 10px;"> Learn
            </a>
          </li>
          <li id="admin-link" style="display: none;">
            <a href="/admin">
              <img src="/static/icons/shield.svg" width="20" style="margin-right: 10px;"> Admin
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <div class="main-content">
      <div class="lesson-container">
        <h1>üéØ Lesson 1: Vowel Sounds</h1>
        <p>Learn the difference between short and long vowels, such as the difference between ‚Äúbit‚Äù and ‚Äúbeat‚Äù.</p>

        <div class="section">
          <h3>üëÇ Hear Examples</h3>
          <button class="word-button" onclick="playWord('bit')">bit</button>
          <button class="word-button" onclick="playWord('beat')">beat</button>
          <button class="word-button" onclick="playWord('hat')">hat</button>
          <button class="word-button" onclick="playWord('hate')">hate</button>
        </div>
        <div class="section" id="practice-section">
          <h3>üéØ Practice Vowel Words</h3>
          <p><strong>Word:</strong> <span id="practice-word">bit</span></p>
        
          <div style="margin-bottom: 10px;">
            <button onclick="playPracticeWord()">üîä Hear</button>
            <button onclick="startPracticeSpeech()">üéô Start</button>
            <button onclick="stopPracticeSpeech()">üõë Stop</button>
            <button onclick="nextPracticeWord()">‚û°Ô∏è Next</button>
          </div>
        
          <p id="practice-listening-indicator" style="display:none; font-weight: bold; color: #007BFF;">üéôÔ∏è Listening...</p>
          <p id="practice-feedback" class="practice-feedback"></p>
        
          <div style="width: 100%; margin-top: 20px;">
            <div style="height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
              <div id="practice-progress" style="height: 8px; width: 0%; background: #3B82F6; transition: width 0.3s;"></div>
            </div>
            <p style="font-size: 0.8rem; text-align: right; margin-top: 4px;">
              <span id="progress-count">1</span> / <span id="progress-total">6</span>
            </p>
          </div>
        </div>        
        
           <!-- Back to Lessons Button -->
        <div class="section" style="text-align: center; margin-top: 40px;">
          <a href="{{ url_for('learn') }}" style="
              display: inline-block;
              background-color: #3B82F6;
              color: white;
              padding: 10px 20px;
              border-radius: 6px;
              text-decoration: none;
              font-weight: 500;
              transition: background-color 0.3s ease;
          ">‚¨ÖÔ∏è Back to Lessons</a>
        </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const practiceWords = ["bit", "beat", "hat", "hate", "pit", "peat", "cat", "kite", "sit", "seat"];
    let practiceIndex = 0;
    let practiceRecognition;
    let practiceCorrectCount = 0;
  
    function getSimilarity(str1, str2) {
      const s1 = str1.toLowerCase().trim();
      const s2 = str2.toLowerCase().trim();
      if (s1 === s2) return 100;
      let matches = 0;
      const minLen = Math.min(s1.length, s2.length);
      for (let i = 0; i < minLen; i++) {
        if (s1[i] === s2[i]) matches++;
      }
      return (matches / Math.max(s1.length, s2.length)) * 100;
    }
  
    function playWord(word) {
      fetch('/get_native_audio?text=' + word)
        .then(res => res.blob())
        .then(blob => {
          const audio = new Audio(URL.createObjectURL(blob));
          audio.play();
        })
        .catch(err => console.error("üéß Error fetching audio:", err));
    }
  
    function playPracticeWord() {
      const word = practiceWords[practiceIndex];
      playWord(word);
    }
  
    function startPracticeSpeech() {
      const expected = practiceWords[practiceIndex];
      const indicator = document.getElementById("practice-listening-indicator");
      const feedback = document.getElementById("practice-feedback");
  
      practiceRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      practiceRecognition.lang = 'en-US';
      practiceRecognition.interimResults = false;
  
      indicator.style.display = 'block';
      feedback.textContent = '';
  
      practiceRecognition.onresult = (event) => {
        const spoken = event.results[0][0].transcript.toLowerCase().trim().replace(/[.,!?]/g, "");
        const similarity = getSimilarity(spoken, expected);
  
        if (similarity >= 80) {
          feedback.textContent = `‚úÖ Correct! You said: "${spoken}"`;
          practiceCorrectCount++;
        } else {
          feedback.textContent = `‚ùå Try again. You said: "${spoken}"`;
        }
  
        indicator.style.display = 'none';
  
        // Auto-advance to next word after 2 seconds
        setTimeout(() => {
          nextPracticeWord();
        }, 2000);
      };
  
      practiceRecognition.onerror = () => {
        indicator.style.display = 'none';
        feedback.textContent = "‚ö†Ô∏è Could not recognize speech.";
      };
  
      practiceRecognition.onend = () => {
        indicator.style.display = 'none';
      };
  
      practiceRecognition.start();
    }
  
    function stopPracticeSpeech() {
      if (practiceRecognition) {
        practiceRecognition.stop();
      }
    }
  
    function nextPracticeWord() {
      practiceIndex++;
      if (practiceIndex >= practiceWords.length) {
        showPracticeResult();
      } else {
        updatePracticeUI();
      }
    }
  
    function updatePracticeUI() {
      document.getElementById("practice-word").textContent = practiceWords[practiceIndex];
      document.getElementById("practice-feedback").textContent = '';
      document.getElementById("progress-count").textContent = practiceIndex + 1;
      document.getElementById("progress-total").textContent = practiceWords.length;
      const percent = ((practiceIndex + 1) / practiceWords.length) * 100;
      document.getElementById("practice-progress").style.width = percent + "%";
    }
  
    function showPracticeResult() {
      const section = document.getElementById("practice-section");
      section.innerHTML = `
        <h3>üéâ Practice Complete!</h3>
        <p>You got <strong>${practiceCorrectCount}/${practiceWords.length}</strong> correct.</p>
        <button onclick="restartPractice()">üîÅ Try Again</button>
      `;
    }
  
    function restartPractice() {
      practiceIndex = 0;
      practiceCorrectCount = 0;
      document.getElementById("practice-section").innerHTML = originalPracticeHTML;
      updatePracticeUI();
    }
  
    // Store original HTML for restart
    let originalPracticeHTML = "";
    window.addEventListener('DOMContentLoaded', () => {
      originalPracticeHTML = document.getElementById("practice-section").innerHTML;
      updatePracticeUI();
    });
  </script>
  
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lesson 4: Ending Sounds</title>
  <link rel="stylesheet" href="/static/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f7f7f7;
    }
    .app-container {
      display: flex;
    }
    .sidebar {
      background-color: #333;
      color: white;
      width: 250px;
      height: 100vh;
      padding: 20px;
      position: fixed;
    }
    .sidebar nav ul {
      list-style: none;
      padding: 0;
    }
    .sidebar nav ul li {
      margin-bottom: 20px;
    }
    .sidebar nav ul li a {
      text-decoration: none;
      color: white;
      font-size: 1rem;
      padding: 10px 15px;
      display: block;
      border-radius: 5px;
      transition: background-color 0.3s, transform 0.2s;
    }
    .sidebar nav ul li a:hover,
    .sidebar nav ul li a.active {
      background-color: #3B82F6;
      transform: translateX(5px);
    }
    .main-content {
      flex-grow: 1;
      margin-left: 250px;
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }
    .lesson-container {
      width: 100%;
      max-width: 800px;
      padding: 0 20px;
      box-sizing: border-box;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .section {
      margin-bottom: 30px;
    }
    .word-button {
      display: inline-block;
      margin: 5px;
      padding: 10px 15px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .try-section input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .try-section button {
      margin-right: 10px;
    }
    #listening-indicator {
      display: none;
      font-weight: bold;
      color: #007BFF;
      margin-top: 10px;
      animation: glow 1.2s ease-in-out infinite alternate;
    }
    @keyframes glow {
      from {
        text-shadow: 0 0 5px #007BFF, 0 0 10px #007BFF;
      }
      to {
        text-shadow: 0 0 10px #33aaff, 0 0 20px #33aaff;
      }
    }
    .practice-feedback {
      font-weight: bold;
      margin-top: 5px;
    }
    #next-quiz-btn {
      margin-top: 10px;
    }
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        position: static;
        text-align: center;
      }
      .main-content {
        margin-left: 0;
        padding: 20px;
        align-items: center;
      }
      .lesson-container {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <script src="{{ url_for('static', filename='lang.js') }}"></script>
  <div class="app-container">
   <!-- Sidebar -->
<aside class="sidebar">
  <div class="app-container">
        <nav>
          <ul>
            <li> <a href="{{ url_for('home') }}">
              <img src="/static/icons/dashboard.svg" width="20" style="margin-right: 10px;">
              <span data-i18n="dashboard">Dashboard</span>
            </a>
          </li>
          <li>
            <a href="{{ url_for('user') }}">
              <img src="/static/icons/user.svg" width="20" style="margin-right: 10px;">
              <span data-i18n="user">User</span>
            </a>
          </li>
          <li>
            <a href="{{ url_for('settings') }}">
              <img src="/static/icons/settings.svg" width="20" style="margin-right: 10px;">
              <span data-i18n="settings">Settings</span>
            </a>
          </li>
          <li>
            <a href="{{ url_for('speech_test') }}" style="display: flex; align-items: center;">
              <img src="/static/icons/mic.svg" width="24" height="24" style="margin-right: 12px;">
              <span data-i18n="speech_test">Speech Test</span>
            </a>
          </li>
          <li>
            <a href="{{ url_for('learn') }}" class="{% if current_page == 'learn' %}active{% endif %}">
              <img src="/static/icons/book.svg" width="20" style="margin-right: 10px;">
              <span data-i18n="learn">Learn</span>
            </a>
          </li>
          <li id="admin-link" style="display: none;">
            <a href="/admin">
              <img src="/static/icons/shield.svg" width="20" style="margin-right: 10px;">
              <span data-i18n="admin">Admin</span>
            </a>
            </li>
          </ul>
        </nav>
      </aside>

    <div class="main-content">
      <div class="lesson-container">
        <h1>üîö Lesson 4: Ending Sounds</h1>
        <p>Practice pronouncing final consonants clearly ‚Äî like in ‚Äúcat‚Äù, ‚Äúwalk‚Äù, and ‚Äúhelp‚Äù.</p>

        <div class="section">
          <h3>üëÇ Hear Examples</h3>
          <button class="word-button" onclick="playWord('cat')">cat</button>
          <button class="word-button" onclick="playWord('walk')">walk</button>
          <button class="word-button" onclick="playWord('help')">help</button>
          <button class="word-button" onclick="playWord('dog')">dog</button>
        </div>

        <div class="section try-section">
          <h3>üé§ Try It Yourself</h3>
          <input id="tryWord" placeholder="Enter a word like 'walk' or 'help'">
          <button onclick="playNativeTry()">üîä Hear</button>
          <button onclick="startTrySpeech()">üéôÔ∏è Speak</button>
          <p id="listening-indicator">üéôÔ∏è Now Listening‚Ä¶ Speak clearly.</p>
          <p id="try-feedback" class="practice-feedback"></p>
        </div>

        <div class="section" id="quiz-section">
          <h3>üß™ Practice Mini Quiz</h3>
          <div id="quiz-card">
            <p><strong>Word <span id="quiz-num">1</span>/5:</strong> <span id="quiz-word">cat</span></p>
            <button onclick="playCurrentQuizWord()">üîä Hear</button>
            <button onclick="startQuizSpeech()">üé§ Speak</button>
            <p id="quiz-listening-indicator" style="display:none; font-weight: bold; color: #007BFF;">üéôÔ∏è Now Listening‚Ä¶ Speak clearly.</p>
            <p id="quiz-feedback" class="practice-feedback"></p>
            <button id="next-quiz-btn" onclick="nextQuizWord()" style="display: none;">‚û°Ô∏è Next</button>
          </div>
        </div>

        <div class="section" style="text-align: center; margin-top: 40px;">
          <a href="{{ url_for('learn') }}" style="
              display: inline-block;
              background-color: #3B82F6;
              color: white;
              padding: 10px 20px;
              border-radius: 6px;
              text-decoration: none;
              font-weight: 500;
              transition: background-color 0.3s ease;
          ">‚¨ÖÔ∏è Back to Lessons</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const allQuizWords = [
      "cat", "dog", "walk", "talk", "help", "kick", "stop", "grab", "snack", "jump",
      "clap", "hug", "laugh", "lift", "lock", "push", "pick", "hop", "bake", "pack"
    ];

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    const quizWords = shuffle([...allQuizWords]).slice(0, 5);
    let quizIndex = 0;

    function playWord(word) {
      fetch('/get_native_audio?text=' + word)
        .then(res => res.blob())
        .then(blob => {
          const audio = new Audio(URL.createObjectURL(blob));
          audio.play();
        });
    }

    function playNativeTry() {
      const word = document.getElementById("tryWord").value.trim();
      if (!word) return alert("Enter a word first!");
      playWord(word);
    }

    function startTrySpeech() {
      const target = document.getElementById("tryWord").value.trim();
      const indicator = document.getElementById("listening-indicator");
      if (!target) return alert("Enter a word first!");

      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;

      indicator.style.display = 'block';

      recognition.onresult = (event) => {
        const spoken = event.results[0][0].transcript.toLowerCase().trim().replace(/[.,!?]/g, "");
        const feedback = document.getElementById("try-feedback");
        indicator.style.display = 'none';

        if (spoken === target.toLowerCase()) {
          feedback.textContent = `‚úÖ Good job! You said: ${spoken}`;
        } else {
          feedback.textContent = `‚ùå Try again. You said: ${spoken}`;
        }
      };

      recognition.onerror = () => {
        indicator.style.display = 'none';
      };

      recognition.onend = () => {
        indicator.style.display = 'none';
      };

      recognition.start();
    }

    function loadQuizWord() {
      const word = quizWords[quizIndex];
      document.getElementById('quiz-word').textContent = word;
      document.getElementById('quiz-num').textContent = quizIndex + 1;
      document.getElementById('quiz-feedback').textContent = '';
      document.getElementById('next-quiz-btn').style.display = 'none';
    }

    function playCurrentQuizWord() {
      const word = quizWords[quizIndex];
      playWord(word);
    }

    function startQuizSpeech() {
      const expected = quizWords[quizIndex];
      const feedback = document.getElementById('quiz-feedback');
      const indicator = document.getElementById('quiz-listening-indicator');

      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;

      indicator.style.display = 'block';

      recognition.onresult = (event) => {
        const spoken = event.results[0][0].transcript.toLowerCase().trim().replace(/[.,!?]/g, "");
        const expectedClean = expected.toLowerCase().trim();

        if (spoken === expectedClean) {
          feedback.textContent = "‚úÖ Correct!";
        } else {
          feedback.textContent = `‚ùå You said: ${spoken}`;
        }

        indicator.style.display = 'none';
        document.getElementById('next-quiz-btn').style.display = 'inline-block';
      };

      recognition.onerror = () => {
        indicator.style.display = 'none';
        feedback.textContent = "‚ö†Ô∏è Could not recognize speech.";
        document.getElementById('next-quiz-btn').style.display = 'inline-block';
      };

      recognition.onend = () => {
        indicator.style.display = 'none';
      };

      recognition.start();
    }

    function nextQuizWord() {
      quizIndex++;
      if (quizIndex >= quizWords.length) {
        document.getElementById('quiz-card').innerHTML = "<h4>üéâ Great job! You've completed the quiz.</h4>";
      } else {
        loadQuizWord();
      }
    }

    function markLessonComplete(lessonNum) {
    const user = firebase.auth().currentUser;
    if (user) {
      firebase.firestore().collection("users").doc(user.uid).set({
        [`lessons.lesson${lessonNum}`]: true
      }, { merge: true });
    } else {
      // Optional: use localStorage for guests
      localStorage.setItem(`lesson${lessonNum}_complete`, "true");
    }
  }

    window.addEventListener('DOMContentLoaded', loadQuizWord);
  </script>
</body>
</html>
